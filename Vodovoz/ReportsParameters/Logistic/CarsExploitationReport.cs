using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;
using System.Linq;
using Gamma.Utilities;
using Gamma.Widgets;
using Gtk;
using QS.Dialog;
using QS.Dialog.GtkUI;
using QS.DomainModel.UoW;
using QS.Project.Journal.EntitySelector;
using QS.Report;
using QS.Services;
using QSReport;
using Vodovoz.CommonEnums;
using Vodovoz.Domain.Logistic;
using Vodovoz.Services;

namespace Vodovoz.ReportsParameters.Logistic
{
    public partial class CarsExploitationReport : SingleUoWWidgetBase, IParametersWidget
    {
        public CarsExploitationReport(
            IUnitOfWorkFactory unitOfWorkFactory,
            IEntityAutocompleteSelectorFactory carAutocompleteSelectorFactory,
            IWageParametersProvider wageParametersProvider,
            IInteractiveService interactiveService)
        {
            if(unitOfWorkFactory == null) {
                throw new ArgumentNullException(nameof(unitOfWorkFactory));
            }
            this.carAutocompleteSelectorFactory = carAutocompleteSelectorFactory ??
                throw new ArgumentNullException(nameof(carAutocompleteSelectorFactory));
            this.wageParametersProvider = wageParametersProvider ??
                throw new ArgumentNullException(nameof(wageParametersProvider));
            this.interactiveService = interactiveService ??
                throw new ArgumentNullException(nameof(interactiveService));

            Build();
            UoW = unitOfWorkFactory.CreateWithoutRoot();
            Configure();
        }

        private readonly IEntityAutocompleteSelectorFactory carAutocompleteSelectorFactory;
        private readonly IWageParametersProvider wageParametersProvider;
        private readonly IInteractiveService interactiveService;

        private void Configure()
        {
            hboxDriverDelayTime.Visible = ylabelDriverScheduleDelay.Visible = false;
            
            yspinMinutes.ValueAsInt = 30;
            
            ybuttonInfo.Clicked += ShowInfoWindow;
            ybuttonSelectAllIndicators.Clicked += (sender, args) => { enumchecklistIndicators.SelectAll(); };
            ybuttonUnselectAllIndicators.Clicked += (sender, args) => { enumchecklistIndicators.UnselectAll(); };

            comboIsRaskat.ItemsEnum = typeof(AllYesNo);

            comboMonth.ItemsEnum = typeof(Month);
            comboMonth.SelectedItem = (Month)DateTime.Today.Month;

            comboYear.DefaultFirst = true;
            comboYear.ItemsList = Enumerable.Range(DateTime.Now.AddYears(-10).Year, 11).Reverse();

            comboIndicatorsType.DefaultFirst = true;
            comboIndicatorsType.ItemsEnum = typeof(IndicatorsType);
            comboIndicatorsType.EnumItemSelected += (sender, args) => UpdateAvailableIndicators();

            enumComboOwnType.ItemsEnum = typeof(CarOwnType);
            enumComboOwnType.EnumItemSelected += (sender, args) => OnComboOwnTypeChanged();

            comboCompanyCarType.ItemsEnum = typeof(CompanyCarType);
            comboCompanyCarType.EnumItemSelected += (sender, args) => UpdateAvailableIndicators();

            comboDriverCarKind.WidthRequest = 150;
            comboDriverCarKind.ItemsList = UoW.GetAll<DriverCarKind>();

            entryCar.SetEntityAutocompleteSelectorFactory(carAutocompleteSelectorFactory);
            entryCar.Changed += (sender, args) => OnEntryCarChanged();

            buttonCreateReport.Clicked += OnButtonCreateReportClicked;

            enumchecklistIndicators.RememberStateOnHide = true;
            enumchecklistIndicators.EnumType = typeof(Indicator);
            enumchecklistIndicators.SelectAll();

            OnComboOwnTypeChanged();
        }

        private void OnButtonCreateReportClicked(object sender, EventArgs args)
        {
            if(!enumchecklistIndicators.SelectedValues.Any()) {
                interactiveService.ShowMessage(ImportanceLevel.Warning, "Не выбрано ни 1 показателя");
                return;
            }
            LoadReport?.Invoke(this, new LoadReportEventArgs(GetReportInfo()));
        }

        private void OnComboOwnTypeChanged()
        {
            var carOwnType = enumComboOwnType.SelectedItem as CarOwnType?;
            switch(carOwnType) {
                case CarOwnType.Company:
                    ylabelCompanyCarType.Visible = true;
                    comboCompanyCarType.Visible = true;

                    comboIsRaskat.Sensitive = false;
                    comboIsRaskat.SelectedItem = AllYesNo.No;
                    ylabelDriverCarType.Visible = false;
                    comboDriverCarKind.Visible = false;
                    comboDriverCarKind.SelectedItem = SpecialComboState.All;
                    break;
                case CarOwnType.Driver:
                    if(entryCar.Subject == null) {
                        comboIsRaskat.Sensitive = true;
                    }

                    ylabelDriverCarType.Visible = true;
                    comboDriverCarKind.Visible = true;

                    ylabelCompanyCarType.Visible = false;
                    comboCompanyCarType.Visible = false;
                    comboCompanyCarType.SelectedItem = SpecialComboState.All;
                    break;
            }

            UpdateAvailableIndicators();
        }

        private void OnEntryCarChanged()
        {
            if(entryCar.Subject is Car car) {
                if(car.IsRaskat && car.IsCompanyCar) {
                    interactiveService.ShowMessage(ImportanceLevel.Warning, "Нельзя выбрать раскатный автомобиль компании в этот отчёт");
                    entryCar.Subject = null;
                    return;
                }
                
                comboCompanyCarType.Sensitive = false;
                comboDriverCarKind.Sensitive = false;
                comboIsRaskat.Sensitive = false;
                enumComboOwnType.Sensitive = false;
                enumComboOwnType.SelectedItem = car.IsCompanyCar ? CarOwnType.Company : CarOwnType.Driver;

                if(enumComboOwnType.SelectedItem is CarOwnType.Company) {
                    switch(car.TypeOfUse) {
                        case CarTypeOfUse.CompanyLargus:
                            comboCompanyCarType.SelectedItem = CompanyCarType.Largus;
                            break;
                        case CarTypeOfUse.CompanyGAZelle:
                            comboCompanyCarType.SelectedItem = CompanyCarType.Gazelle;
                            break;
                        default:
                            throw new InvalidOperationException();
                    }
                }
                else {
                    comboDriverCarKind.SelectedItem = car.DriverCarKind ?? (object)SpecialComboState.All;
                    comboIsRaskat.SelectedItem = car.IsRaskat ? AllYesNo.Yes : AllYesNo.No;
                }
            }
            else {
                enumComboOwnType.Sensitive = true;
                comboDriverCarKind.Sensitive = true;
                comboCompanyCarType.Sensitive = true;
                comboIsRaskat.Sensitive = true;
            }
            OnComboOwnTypeChanged();
        }

        private void UpdateAvailableIndicators()
        {
            enumchecklistIndicators.ClearEnumHideList();
            
            enumchecklistIndicators.AddEnumToHideList(new Enum[] { Indicator.WorkSchedules });

            if((IndicatorsType)comboIndicatorsType.SelectedItem == IndicatorsType.Plan) {
                enumchecklistIndicators.AddEnumToHideList(new Enum[] {
                    Indicator.MileageRecalculated,
                    Indicator.MileageConfirmed,
                    Indicator.FuelOverspending,
                    Indicator.Undeliveries,
                    Indicator.LateArrivals,
                    Indicator.WorkSchedules
                });
            }
            else {
                enumchecklistIndicators.AddEnumToHideList(new Enum[] { Indicator.MileagePlan });
            }

            switch(enumComboOwnType.SelectedItem as CarOwnType?) {
                case CarOwnType.Company:
                    if(comboCompanyCarType.SelectedItem is CompanyCarType.Largus) {
                        enumchecklistIndicators.AddEnumToHideList(new Enum[] { Indicator.Forwarders });
                    }
                    break;
                case CarOwnType.Driver:
                    enumchecklistIndicators.AddEnumToHideList(new Enum[]
                        { Indicator.MileageConfirmed, Indicator.MileagePlan, Indicator.MileageRecalculated, Indicator.FuelOverspending });
                    break;
            }
        }

        public string Title => "Аналитика эксплуатации ТС";

        public event EventHandler<LoadReportEventArgs> LoadReport;

        private ReportInfo GetReportInfo()
        {
            var selectedYear = (int)comboYear.SelectedItem;
            var selectedMonth = (int)comboMonth.SelectedItem;

            var driverCarTypeId = "";
            if(!comboDriverCarKind.IsSelectedAll && comboDriverCarKind.SelectedItem is DriverCarKind driverCarKind) {
                driverCarTypeId = driverCarKind.Id.ToString();
            }

            bool? isRaskat = null;
            switch((AllYesNo)comboIsRaskat.SelectedItem) {
                case AllYesNo.Yes:
                    isRaskat = true;
                    break;
                case AllYesNo.No:
                    isRaskat = false;
                    break;
            }

            CarTypeOfUse[] carTypeOfUse = null;
            if(enumComboOwnType.SelectedItem is CarOwnType.Driver) {
                carTypeOfUse = new[] { CarTypeOfUse.DriverCar };
            }
            else {
                switch(comboCompanyCarType.SelectedItem) {
                    case SpecialComboState.All:
                        carTypeOfUse = new[] { CarTypeOfUse.CompanyLargus, CarTypeOfUse.CompanyGAZelle };
                        break;
                    case CompanyCarType.Largus:
                        carTypeOfUse = new[] { CarTypeOfUse.CompanyLargus };
                        break;
                    case CompanyCarType.Gazelle:
                        carTypeOfUse = new[] { CarTypeOfUse.CompanyGAZelle };
                        break;
                }
            }

            return new ReportInfo {
                Identifier = "Logistic.CarsExploitationReport",
                Parameters = new Dictionary<string, object> {
                    { "start_date", new DateTime(selectedYear, selectedMonth, 1) }, {
                        "end_date",
                        new DateTime(selectedYear, selectedMonth, DateTime.DaysInMonth(selectedYear, selectedMonth),
                            23, 59, 59)
                    },
                    { "indicators_type", ((IndicatorsType)comboIndicatorsType.SelectedItem).ToString() },
                    { "driver_car_kind_id", driverCarTypeId },
                    { "car_id", entryCar.Subject == null ? (object)null : entryCar.SubjectId },
                    { "indicators", enumchecklistIndicators.SelectedValues.Select(x => x.GetEnumTitle()) },
                    { "suburb_wage_district_id", wageParametersProvider.GetSuburbWageDistrictId },
                    { "creation_date", DateTime.Now },
                    { "driver_schedule_delay", new TimeSpan(yspinHours.ValueAsInt, yspinMinutes.ValueAsInt, 0) },
                    { "car_type_of_use", carTypeOfUse },
                    { "is_raskat", isRaskat },
                    { "selected_filters_string", GetSelectedFiltersString() },
                    { "show_row_number", enumchecklistIndicators.SelectedValues.Count() == 1}
                }
            };
        }

        private string GetSelectedFiltersString()
        {
            string str;

            if(entryCar.Subject is Car car) {
                str = $"Автомобиль: {car.RegistrationNumber}\n";
            }
            else {
                str = $"Принадлежность: {((CarOwnType)enumComboOwnType.SelectedItem).GetEnumTitle()}\n";

                if(enumComboOwnType.SelectedItem is CarOwnType.Driver) {
                    var driverCarKind = comboDriverCarKind.IsSelectedAll
                        ? "Все"
                        : ((DriverCarKind)comboDriverCarKind.SelectedItem).Name;
                    str += $"Вид авто водителя: {driverCarKind}\n";
                }
                else {
                    var companyCarType = comboCompanyCarType.SelectedItem is SpecialComboState.All
                        ? "Все"
                        : ((CompanyCarType)comboCompanyCarType.SelectedItem).GetEnumTitle();
                    str += $"Тип авто компании: {companyCarType}\n";
                }

                str += $"Раскат: {((AllYesNo)comboIsRaskat.SelectedItem).GetEnumTitle()}\n";
            }
            
            str += $"Подсчёт по {((IndicatorsType)comboIndicatorsType.SelectedItem).GetEnumTitle()} данным\n";
            str += $"Отсрочка времени графиков: {yspinHours.ValueAsInt}ч. {yspinMinutes.ValueAsInt}мин.\n";
            str += $"Выбранные показатели: {String.Join(", ", enumchecklistIndicators.SelectedValuesList.Select(x => x.GetEnumTitle()))}";

            return str;
        }

        public enum IndicatorsType
        {
            [Display(Name = "фактическим")]
            Fact,
            [Display(Name = "планируемым")]
            Plan
        }

        public enum CarOwnType
        {
            [Display(Name = "Автопарк компании")]
            Company,
            [Display(Name = "Наёмный транспорт")]
            Driver
        }

        public enum CompanyCarType
        {
            [Display(Name = "Ларгус")]
            Largus,
            [Display(Name = "Газель")]
            Gazelle
        }

        public enum Indicator
        {
            [Display(Name = "Рейсы")]
            Trips,
            [Display(Name = "Город/Пригород")]
            WageDistricts,
            [Display(Name = "Км предп")]
            MileagePlan,
            [Display(Name = "Км пересчит")]
            MileageRecalculated,
            [Display(Name = "Км подтв")]
            MileageConfirmed,
            [Display(Name = "Перерасход")]
            FuelOverspending,
            [Display(Name = "Недовозы")]
            Undeliveries,
            [Display(Name = "Опоздания")]
            LateArrivals,
            [Display(Name = "График")]
            WorkSchedules,
            [Display(Name = "Районы")]
            Districts,
            [Display(Name = "Адреса")]
            Addresses,
            [Display(Name = "Экспедиторы")]
            Forwarders,
            [Display(Name = "Загрузка")]
            LoadingAverage,
            [Display(Name = "19л")]
            Loading19Litres,
            [Display(Name = "кг")]
            LoadingKilograms,
            [Display(Name = "м3")]
            LoadingCubicMeters
        }

        private void ShowInfoWindow(object sender, EventArgs e)
        {
            var info =
                "Условные обозначения отчёта: <b>К</b> - авто компании, <b>Н</b> - наёмный автомобиль, <b>Л</b> - Ларгус, <b>Г</b> - Газель.\n" +
                "Столбики: <b>П</b> - принадлежность. <b>Т</b> - тип (Для <b>Н</b>: Сокр. название вида наёмного авто). <b>№</b> - номер. Показатель. <b>1,2,3</b> - даты в месяце.\n" +
                "Выборка в отчёт идёт согласно фильтрам и доп. условиям:\n" +
                " - Не попадают архивные автомобили, фуры, а также автомобили, привязанные к выездным мастерам.\n" +
                "Пояснения к показателям:\n\n" +
                "Условные обозначения: <b>Факт</b> - фильтр по фактическим данным. <b>План</b> - фильтр по планируемым данным.\n\n" +

                $"<b>{Indicator.Trips.GetEnumTitle()}</b>: Сумма Кол-ва МЛ.\n" +
                $"Факт: не считает МЛ, у которых все адреса в статусах {RouteListItemStatus.Transfered.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()} и {RouteListItemStatus.Canceled.GetEnumTitle()}.\n\n" +

                $"<b>{Indicator.WageDistricts.GetEnumTitle()}</b>: Если за день есть хоть один адрес в Пригороде - П, иначе Г.\n" +
                $"Факт: не считаются адреса в статусах {RouteListItemStatus.Transfered.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()} и {RouteListItemStatus.Canceled.GetEnumTitle()}.\n" +
                "План: не считаются адреса, перенесённые в этот МЛ.\n\n" +

                $"<b>{Indicator.MileagePlan.GetEnumTitle()}</b>: Сумма планируемого расстояния по всем МЛ.\n" +
                "Не отображается для <b>Н</b>.\n" +
                "Факт: не отображается.\n\n" +

                $"<b>{Indicator.MileageRecalculated.GetEnumTitle()}</b>: Сумма пересчитанного расстояния по всем МЛ.\n" +
                "Не отображается для <b>Н</b>.\n" +
                "План: не отображается.\n\n" +

                $"<b>{Indicator.MileageConfirmed.GetEnumTitle()}</b>: Сумма подтверждённого расстояния по всем МЛ.\n" +
                "Не отображается для <b>Н</b>.\n" +
                "План: не отображается.\n\n" +

                $"<b>{Indicator.FuelOverspending.GetEnumTitle()}</b>: Разница подтверждённого и пересчитанного расстояний по всем МЛ.\n" +
                "Не отображается для <b>Н</b>.\n" +
                "План: не отображается.\n\n" +

                $"<b>{Indicator.Undeliveries.GetEnumTitle()}</b>: Сумма кол-ва отмен заказов по всем МЛ по вине Подразделений логистики и Водителей.\n" +
                "План: не отображается.\n\n" +

                $"<b>{Indicator.LateArrivals.GetEnumTitle()}</b>: Сумма кол-ва опозданий по всем адресам по всем МЛ.\n" +
                "План: не отображается.\n\n" +

                $"<b>{Indicator.Addresses.GetEnumTitle()}</b>: Сумма кол-ва адресов во всех МЛ.\n" +
                $"Факт: не считаются адреса в статусах {RouteListItemStatus.Transfered.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()} и {RouteListItemStatus.Canceled.GetEnumTitle()}.\n" +
                "План: не считаются адреса, перенесённые в этот МЛ.\n\n" +

                $"<b>{Indicator.Forwarders.GetEnumTitle()}</b>: Сумма кол-ва МЛ с экспедиторами.\n" +
                "Не отображается для <b>К Л</b>.\n" +
                $"Факт: Не считает МЛ, у которых все адреса в статусах {RouteListItemStatus.Transfered.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()} и {RouteListItemStatus.Canceled.GetEnumTitle()}.\n\n" +

                // $"<b>{Indicator.WorkSchedules.GetEnumTitle()}</b>: Сумма кол-ва всех выходов за график работы водителя по всем МЛ.\n" +
                // "Смена водителя берётся из МЛ. Если у водителя на день МЛ (и день недели) нет такой смены – выход из графика.\n" +
                // "Выходом за график считается:\n" +
                // "   – Если время первого документа погрузки МЛ меньше или больше времени начала работы водителя.\n" +
                // "   – Если в МЛ есть хоть 1 адрес, который изменил свой статус на конечный и не является переносом\n" +
                // $"     ({RouteListItemStatus.Completed.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()}, {RouteListItemStatus.Canceled.GetEnumTitle()}) позже времени окончания работы водителя.\n" +
                // "План: не отображается.\n\n" +

                $"<b>{Indicator.Districts.GetEnumTitle()}</b>: Сумма кол-ва адресов во всех МЛ, не попадающих в районы, закрепленные за водителем в МЛ.\n" +
                "Версия приоритетов районов водителя подбирается аналогично версии графиков.\n" +
                $"Факт: не считаются адреса в статусах {RouteListItemStatus.Transfered.GetEnumTitle()}, {RouteListItemStatus.Overdue.GetEnumTitle()} и {RouteListItemStatus.Canceled.GetEnumTitle()}.\n" +
                "План: не считаются адреса, перенесённые в этот МЛ.\n\n" +

                $"<b>{Indicator.Loading19Litres.GetEnumTitle()}, {Indicator.LoadingKilograms.GetEnumTitle()}, {Indicator.LoadingCubicMeters.GetEnumTitle()}</b>: Сумма процентной загрузки авто по всем МЛ.\n" +
                "Факт: считаются только выполненные адреса.\n" +
                "План: не считаются адреса, перенесённые в этот МЛ.\n\n" +

                $"<b>{Indicator.LoadingAverage.GetEnumTitle()}</b>: Cреднее по 19л, кг, м3.";

            var label = new Label { Markup = info };
            label.SetPadding(10, 10);
            var vbox = new VBox { label };

            var messageWindow = new Window(WindowType.Toplevel) {
                Resizable = false, 
                Title = "Информация", 
                WindowPosition = WindowPosition.Center,
                Modal = true
            };
            messageWindow.Add(vbox);
            messageWindow.ShowAll();
        }
    }
}
