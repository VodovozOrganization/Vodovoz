<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Description>
  </Description>
  <Author>
  </Author>
  <PageHeight>209.804mm</PageHeight>
  <PageWidth>296.926mm</PageWidth>
  <Width>7.5in</Width>
  <TopMargin>5mm</TopMargin>
  <LeftMargin>5mm</LeftMargin>
  <RightMargin>5mm</RightMargin>
  <BottomMargin>5mm</BottomMargin>
  <PageHeader>
    <Height>53.9pt</Height>
    <PrintOnFirstPage>true</PrintOnFirstPage>
    <PrintOnLastPage>true</PrintOnLastPage>
    <ReportItems>
      <Textbox Name="Textbox28">
        <Height>18.79pt</Height>
        <Width>804.04pt</Width>
        <Value>Отчет по потенциальным халявщикам</Value>
        <ZIndex>1</ZIndex>
        <Left>5.70pt</Left>
        <Top>6.10pt</Top>
        <Style>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
          <FontSize>14pt</FontSize>
          <FontWeight>Bold</FontWeight>
          <TextAlign>Center</TextAlign>
        </Style>
      </Textbox>
      <Textbox Name="Textbox3">
        <Height>18.01pt</Height>
        <Width>392.19pt</Width>
        <Value>="с " + Format(CDate({?start_date}), "dd.MM.yyyy") + " по " + Format(CDate({?end_date}), "dd.MM.yyyy")</Value>
        <ZIndex>1</ZIndex>
        <Left>217.82pt</Left>
        <Top>22.90pt</Top>
        <Style>
          <TextAlign>Center</TextAlign>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
        </Style>
      </Textbox>
    </ReportItems>
  </PageHeader>
  <Body>
    <Height>67.6pt</Height>
    <Columns>1</Columns>
    <ReportItems>
      <Table Name="Table1">
        <DataSetName>Data</DataSetName>
        <NoRows>Query returned no rows!</NoRows>
        <Style>
          <BorderStyle>
            <Default>Solid</Default>
          </BorderStyle>
          <BorderColor />
          <BorderWidth />
        </Style>
        <TableColumns>
          <TableColumn>
            <Width>25.1pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>142.8pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>75.7pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>73.5pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>138.4pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>63.0pt</Width>
          </TableColumn>
          <TableColumn >
            <Width>65.4pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>65.4pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>87.9pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>80.7pt</Width>
          </TableColumn>
        </TableColumns>
        <Header>
          <TableRows>
            <TableRow>
              <Height>20pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox31">
                      <Value>№
п/п</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                        <FontSize>8pt</FontSize>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox2">
                      <Value>Адрес</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                        <FontSize>8pt</FontSize>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox7">
                      <Value>Тип объекта</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                        <FontSize>8pt</FontSize>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox4">
                      <Value>Телефон</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox5">
                      <Value>Клиент</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox6">
                      <Value>Заказ</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell >
                  <ReportItems>
                    <Textbox Name="Textbox11">
                      <Value>Дата создания</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox8">
                      <Value>Дата заказа</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox9">
                      <Value>Промонабор</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox35">
                      <Value>Автор</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
          <RepeatOnNewPage>true</RepeatOnNewPage>
        </Header>
        <Details>
          <TableRows>
            <TableRow>
              <Height>20.2pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox32">
                      <Value>=RowNumber()</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox15">
                      <Value>={address}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox10">
                      <Value>={dp_object_type}</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                      <CanGrow>true</CanGrow>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox17">
                      <Value>={phone}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <Format>dd/MM/yyyy</Format>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox18">
                      <Value>={client_name}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox19">
                      <Value>={additional_promoset_order_id}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell >
                  <ReportItems>
                    <Textbox Name="Textbox12">
                      <Value>={additional_promoset_order_creation_date}</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <Format>dd.MM.yyyy</Format>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox21">
                      <Value>={additional_promoset_order_delivery_date}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <Format>dd.MM.yyyy</Format>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox22">
                      <Value>={promoset_name}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox36">
                      <Value>={author}</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontSize>8pt</FontSize>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Center</TextAlign>
                        <VerticalAlign>Middle</VerticalAlign>
                        <FontWeight>=Iif({find_base_order} = 1, Bold, Normal)</FontWeight>
                      </Style>
                      <CanGrow>true</CanGrow>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
        </Details>
        <Left>3.5pt</Left>
        <Top>12.6pt</Top>
      </Table>
    </ReportItems>
  </Body>
  <PageFooter>
    <Height>18.3pt</Height>
    <ReportItems>
      <Textbox Name="Textbox1">
        <Top>1pt</Top>
        <Left>10pt</Left>
        <Height>12pt</Height>
        <Width>3in</Width>
        <Value>=Globals!PageNumber + ' of ' + Globals!TotalPages</Value>
        <Style>
          <FontSize>8pt</FontSize>
          <FontWeight>Normal</FontWeight>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
        </Style>
      </Textbox>
    </ReportItems>
    <PrintOnFirstPage>true</PrintOnFirstPage>
    <PrintOnLastPage>true</PrintOnLastPage>
  </PageFooter>
  <DataSets>
    <DataSet Name="Data">
      <Query >
        <DataSourceName>DS1</DataSourceName>
        <Timeout>500</Timeout>
        <CommandText>SELECT

	first_base_order_ordering as find_base_order,

	base_order_id as base_order_id,

	api_compiled_address_short as address,

	(SELECT name FROM delivery_point_categories dpc WHERE id = delivery_point_category_id) as dp_object_type,

	additional_promoset_phone as phone,

	client_name as client_name,

	additional_promoset_order_id as additional_promoset_order_id,

	additional_promoset_order_creation_date as additional_promoset_order_creation_date,

	additional_promoset_order_delivery_date as additional_promoset_order_delivery_date,

	(

    	SELECT 

    		GROUP_CONCAT(DISTINCT sq_ps.name SEPARATOR ', ')

    	FROM promotional_sets sq_ps 

    		LEFT JOIN order_items sq_oi ON sq_oi.promotional_set_id = sq_ps.id 

    	WHERE sq_oi.order_id = additional_promoset_order_id

    ) as promoset_name, 

    (

    	SELECT GET_PERSON_NAME_WITH_INITIALS(e.last_name, e.name, e.patronymic) 

		FROM employees e 

		WHERE e.id = promosets_orders.additional_promoset_order_author_id

    ) as author    

FROM (



	# Запрос для поиска заказов с одним и тем же адресом на которые были оформлены несколько промонаборов

	SELECT

	    o.id as base_order_id,

	    1 as query_group_ordering,

	    2 as first_base_order_ordering,

	    additional_promosets_info.compiled_address_short as api_compiled_address_short,

	    additional_promosets_info.delivery_point_id,

	    additional_promosets_info.delivery_point_category_id,

	    c.name as client_name,

	    additional_promosets_info.order_id as additional_promoset_order_id,

	    additional_promosets_info.author_id as additional_promoset_order_author_id,

	    additional_promosets_info.create_date as additional_promoset_order_creation_date,

	    additional_promosets_info.delivery_date as additional_promoset_order_delivery_date,

	    '' as additional_promoset_phone       

	FROM

	    orders o

	    LEFT JOIN delivery_points dp_source ON dp_source.id = o.delivery_point_id

	    

	    LEFT JOIN (

	        SELECT 

	            o_api.id as order_id,

	            o_api.author_employee_id as author_id,

	            o_api.client_id,

	            o_api.create_date,

	            o_api.delivery_date,

	            dp_api.id as delivery_point_id,

	            dp_api.delivery_point_category_id as delivery_point_category_id,

	            dp_api.city,

	            dp_api.street,

	            dp_api.building,

	            dp_api.room,

	            dp_api.compiled_address_short            

	        FROM delivery_points dp_api

	            LEFT JOIN orders o_api ON o_api.delivery_point_id = dp_api.id

	        WHERE

	            o_api.id IN (SELECT order_id FROM order_items WHERE promotional_set_id IS NOT NULL)

	            AND o_api.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

	    ) as additional_promosets_info

		    ON  additional_promosets_info.city = dp_source.city 

		    	AND additional_promosets_info.street = dp_source.street

		        AND additional_promosets_info.building = dp_source.building 

		        AND additional_promosets_info.room = dp_source.room 

		        AND additional_promosets_info.order_id != o.id

		        

	    LEFT JOIN counterparty c ON c.id = additional_promosets_info.client_id

	    

	WHERE

	    (o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59'))

	    AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

	    AND o.id IN (SELECT order_id FROM order_items WHERE promotional_set_id IN (@promosets))

	    AND additional_promosets_info.order_id IS NOT NULL

	

	UNION ALL

	

	# Запрос для отображения в том же общем списке самого заказа (по точкам доставки) по которому и производился поиск заказов с дополнительными промонаборами 

	SELECT

	    o.id as base_order_id,

	    1 as query_group_ordering,

	    1 as first_base_order_ordering,

	    dp_source.compiled_address_short as api_compiled_address_short,

	    dp_source.id as delivery_point_id,

	    dp_source.delivery_point_category_id as delivery_point_category_id,

	    c.full_name as client_name,	    

		o.id as additional_promoset_order_id,

		o.author_employee_id as additional_promoset_order_author_id,

	    o.create_date as additional_promoset_order_creation_date,

	    o.delivery_date as additional_promoset_order_delivery_date,

	    '' as additional_promoset_phone

	FROM

	    orders o

	    LEFT JOIN delivery_points dp_source ON dp_source.id = o.delivery_point_id

	    LEFT JOIN counterparty c ON c.id = o.client_id    

	WHERE

	    (o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59'))

	    AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

	    AND o.id IN (SELECT order_id FROM order_items WHERE promotional_set_id IN (@promosets))

	    AND EXISTS (

	    	SELECT

	            o_api.id

	        FROM orders o_api

	            LEFT JOIN delivery_points dp_api ON o_api.delivery_point_id = dp_api.id

	        WHERE

	            o_api.id IN (SELECT order_id FROM order_items WHERE promotional_set_id IS NOT NULL)

	            AND o_api.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

	            AND dp_api.city = dp_source.city

	            AND dp_api.street = dp_source.street

	        	AND dp_api.building = dp_source.building

	        	AND dp_api.room = dp_source.room

	        	AND o_api.id != o.id

	    )

	    

	UNION ALL



	# Запрос для поиска заказов с одним и тем же номером телефона на которые были оформлены несколько промонаборов

	SELECT		

		o.id as base_order_id,

		2 as query_group_ordering,

		2 as first_base_order_ordering,

		additional_promosets_info.compiled_address_short as api_compiled_address_short,

		additional_promosets_info.delivery_point_id,

		additional_promosets_info.delivery_point_category_id,

		additional_promosets_info.name as client_name,

		additional_promosets_info.id as additional_promoset_order_id,

		additional_promosets_info.author_employee_id as additional_promoset_order_author_id,

		additional_promosets_info.create_date as additional_promoset_order_creation_date,

		additional_promosets_info.delivery_date as additional_promoset_order_delivery_date,

		(SELECT GROUP_CONCAT(DISTINCT sub_p.`number` SEPARATOR ', ') FROM phones sub_p WHERE sub_p.counterparty_id = o.client_id OR sub_p.delivery_point_id = o.delivery_point_id AND sub_p.is_archive = 0) as additional_promoset_phone

		

	FROM 

		orders o

		LEFT JOIN order_items oi ON o.id = oi.order_id

		LEFT JOIN phones p ON p.counterparty_id = o.client_id AND p.is_archive = 0

		LEFT JOIN phones p2 ON p2.delivery_point_id = o.delivery_point_id AND p2.is_archive = 0

		LEFT JOIN (

			SELECT

				orders_phone_info.id,

				orders_phone_info.create_date,

				orders_phone_info.delivery_date,

				c.name,

				dp.compiled_address_short,

				dp.id as delivery_point_id,

				dp.delivery_point_category_id as delivery_point_category_id,

				orders_phone_info.phone,

				orders_phone_info.digit_phone,

				orders_phone_info.author_employee_id

			FROM

				(

					#заказы с телефонами по контрагенту

					SELECT

						o.id,

						o.client_id,

						o.delivery_point_id,

						o.create_date,

						o.delivery_date,

						o.author_employee_id,

						p.`number` as phone,

						p.digits_number as digit_phone

					FROM orders o

						LEFT JOIN order_items oi ON oi.order_id = o.id

						LEFT JOIN phones p ON o.client_id = p.counterparty_id AND p.is_archive = 0

					WHERE

						p.digits_number IN (

							SELECT

								DISTINCT pp.digits_number 

							FROM

								phones pp

								LEFT JOIN (

									SELECT

										o.id,

										o.client_id,

										o.delivery_point_id

									FROM 

										orders o

										LEFT JOIN order_items oi ON o.id = oi.order_id

									WHERE 

										oi.promotional_set_id IN (@promosets)

										AND o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

										AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')
										

								) as oo ON pp.delivery_point_id = oo.delivery_point_id OR pp.counterparty_id = oo.client_id AND pp.is_archive = 0

							WHERE

								oo.id IS NOT NULL

						)

						AND oi.promotional_set_id IS NOT NULL

						AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

			

				UNION ALL

				

					#заказы с телефонами по точке доставки

					SELECT

						o.id,

						o.client_id,

						o.delivery_point_id,

						o.create_date,

						o.delivery_date,

						o.author_employee_id,

						p.`number` as phone,

						p.digits_number as digit_phone

					FROM orders o

						LEFT JOIN order_items oi ON oi.order_id = o.id

						LEFT JOIN phones p ON o.delivery_point_id = p.delivery_point_id AND p.is_archive = 0

					WHERE

						p.digits_number IN (

							SELECT

								DISTINCT pp.digits_number 

							FROM

								phones pp

								LEFT JOIN (

									SELECT

										o.id,

										o.client_id,

										o.delivery_point_id

									FROM 

										orders o

										LEFT JOIN order_items oi ON o.id = oi.order_id

									WHERE 

										oi.promotional_set_id IN (@promosets)

										AND o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

										AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

								) as oo ON pp.delivery_point_id = oo.delivery_point_id OR pp.counterparty_id = oo.client_id AND pp.is_archive = 0

							WHERE

								oo.id IS NOT NULL

						)

						AND oi.promotional_set_id IS NOT NULL

						AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

				) as orders_phone_info

				LEFT JOIN counterparty c ON c.id = orders_phone_info.client_id

				LEFT JOIN delivery_points dp ON dp.id = orders_phone_info.delivery_point_id			

		) additional_promosets_info ON (additional_promosets_info.digit_phone = p.digits_number OR additional_promosets_info.digit_phone = p2.digits_number) AND additional_promosets_info.id != o.id

	WHERE 

		oi.promotional_set_id IN (@promosets)

		AND o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

		AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

		AND additional_promosets_info.id IS NOT NULL

	GROUP BY o.id, additional_promosets_info.id   

	

	

	UNION ALL

	

	# Запрос для отображения в том же общем списке самого заказа (по телефонам) по которому и производился поиск заказов с дополнительными промонаборами

	SELECT

		o.id as base_order_id,

		2 as query_group_ordering,

		1 as first_base_order_ordering,

		dp_source.compiled_address_short as api_compiled_address_short,

		dp_source.id as delivery_point_id,

		dp_source.delivery_point_category_id as delivery_point_category_id,

		c.full_name as client_name,

		o.id as additional_promoset_order_id,

		o.author_employee_id as additional_promoset_order_author_id,

		o.create_date as additional_promoset_order_creation_date,

		o.delivery_date as additional_promoset_order_delivery_date,		

		(SELECT GROUP_CONCAT(DISTINCT sub_p.`number` SEPARATOR ', ') FROM phones sub_p WHERE sub_p.counterparty_id = o.client_id OR sub_p.delivery_point_id = o.delivery_point_id) as additional_promoset_phone

	FROM 

		orders o

		LEFT JOIN order_items oi ON o.id = oi.order_id

		LEFT JOIN delivery_points dp_source ON dp_source.id = o.delivery_point_id

		LEFT JOIN counterparty c ON c.id = o.client_id  

		LEFT JOIN phones p ON p.counterparty_id = o.client_id AND p.is_archive = 0

		LEFT JOIN phones p2 ON p2.delivery_point_id = o.delivery_point_id AND p2.is_archive = 0

	WHERE 

		oi.promotional_set_id IN (@promosets)

		AND o.create_date &gt;= DATE(@start_date) AND o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

		AND o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

		AND EXISTS (

			SELECT

				orders_phone_info.id,

				orders_phone_info.delivery_date,

				sub_c.name,

				sub_dp.compiled_address_short,

				orders_phone_info.phone,

				orders_phone_info.digit_phone

			FROM

				(

					#заказы с телефонами по контрагенту

					SELECT

						api_o.id,

						api_o.client_id,

						api_o.delivery_point_id,

						api_o.delivery_date,

						api_p.`number` as phone,

						api_p.digits_number as digit_phone

					FROM orders api_o

						LEFT JOIN order_items api_oi ON api_oi.order_id = api_o.id

						LEFT JOIN phones api_p ON api_o.client_id = api_p.counterparty_id AND api_p.is_archive = 0

					WHERE

						api_p.digits_number IN (

							SELECT

								DISTINCT pp.digits_number 

							FROM

								phones pp

								LEFT JOIN (

									SELECT

										inner_api_o.id,

										inner_api_o.client_id,

										inner_api_o.delivery_point_id

									FROM 

										orders inner_api_o

										LEFT JOIN order_items inner_api_oi ON inner_api_o.id = inner_api_oi.order_id

									WHERE 

										inner_api_oi.promotional_set_id IN (@promosets)

										AND inner_api_o.create_date &gt;= DATE(@start_date) AND inner_api_o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

										AND inner_api_o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

								) as oo ON pp.delivery_point_id = oo.delivery_point_id OR pp.counterparty_id = oo.client_id AND pp.is_archive = 0

							WHERE

								oo.id IS NOT NULL

						)

						AND api_oi.promotional_set_id IS NOT NULL

						AND api_o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

			

				UNION ALL

				

					#заказы с телефонами по точке доставки

					SELECT

						api_o.id,

						api_o.client_id,

						api_o.delivery_point_id,

						api_o.delivery_date,

						api_p.`number` as phone,

						api_p.digits_number as digit_phone

					FROM orders api_o

						LEFT JOIN order_items api_oi ON api_oi.order_id = api_o.id

						LEFT JOIN phones api_p ON api_o.delivery_point_id = api_p.delivery_point_id

					WHERE

						api_p.digits_number IN (

							SELECT

								DISTINCT pp.digits_number 

							FROM

								phones pp

								LEFT JOIN (

									SELECT

										inner_api_o.id,

										inner_api_o.client_id,

										inner_api_o.delivery_point_id

									FROM 

										orders inner_api_o

										LEFT JOIN order_items inner_api_oi ON inner_api_o.id = inner_api_oi.order_id

									WHERE 

										inner_api_oi.promotional_set_id IN (@promosets)

										AND inner_api_o.create_date &gt;= DATE(@start_date) AND inner_api_o.create_date &lt;= CONCAT(DATE(@end_date), ' 23:59:59')

										AND inner_api_o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

								) as oo ON pp.delivery_point_id = oo.delivery_point_id OR pp.counterparty_id = oo.client_id

							WHERE

								oo.id IS NOT NULL

						)

						AND api_oi.promotional_set_id IS NOT NULL

						AND api_o.order_status NOT IN ('Canceled','NotDelivered','DeliveryCanceled')

				) as orders_phone_info

				LEFT JOIN counterparty sub_c ON sub_c.id = orders_phone_info.client_id

				LEFT JOIN delivery_points sub_dp ON sub_dp.id = orders_phone_info.delivery_point_id

			WHERE (orders_phone_info.digit_phone = p.digits_number OR orders_phone_info.digit_phone = p2.digits_number) AND orders_phone_info.id != o.id

		)

	GROUP BY o.id

	

) as promosets_orders

ORDER BY query_group_ordering, base_order_id, first_base_order_ordering</CommandText>
        <QueryParameters>
          <QueryParameter Name="start_date">
            <Value>={?start_date}</Value>
          </QueryParameter>
          <QueryParameter Name="end_date">
            <Value>={?end_date}</Value>
          </QueryParameter>
          <QueryParameter Name="promosets">
            <Value>={?promosets}</Value>
          </QueryParameter>
        </QueryParameters>
      </Query>
      <Fields >
        <Field Name="base_order_id">
          <DataField>base_order_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="address">
          <DataField>address</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="phone">
          <DataField>phone</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="client_name">
          <DataField>client_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="additional_promoset_order_id">
          <DataField>additional_promoset_order_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="additional_promoset_order_delivery_date">
          <DataField>additional_promoset_order_delivery_date</DataField>
          <TypeName>System.DateTime</TypeName>
        </Field>
        <Field Name="promoset_name">
          <DataField>promoset_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="author">
          <DataField>author</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="find_base_order">
          <DataField>find_base_order</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="dp_object_type">
          <DataField>dp_object_type</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="additional_promoset_order_creation_date">
          <DataField>additional_promoset_order_creation_date</DataField>
          <TypeName>System.DateTime</TypeName>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <DataElementName>Report</DataElementName>
  <DataElementStyle>AttributeNormal</DataElementStyle>
  <DataSources>
    <DataSource Name="DS1">
      <ConnectionProperties>
        <DataProvider>MySqlConnector</DataProvider>
        <ConnectString>database=Vodovoz_temp;user=enzogord;password=qwerty;port=3306;server=vod-srv.qsolution.ru</ConnectString>
        <IntegratedSecurity>false</IntegratedSecurity>
      </ConnectionProperties>
    </DataSource>
  </DataSources>
  <ReportParameters>
    <ReportParameter Name="start_date">
      <DataType>String</DataType>
      <Nullable>true</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt>
      </Prompt>
    </ReportParameter>
    <ReportParameter Name="end_date">
      <DataType>String</DataType>
      <Nullable>true</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt>
      </Prompt>
    </ReportParameter>
    <ReportParameter Name="promosets">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt>
      </Prompt>
    </ReportParameter>
  </ReportParameters>
</Report>
