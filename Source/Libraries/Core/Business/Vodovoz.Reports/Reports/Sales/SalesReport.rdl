<?xml version="1.0" encoding="UTF-8"?>
<Report xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition" xmlns:rd="http://schemas.microsoft.com/SQLServer/reporting/reportdesigner">
  <Description></Description>
  <Author></Author>
  <PageHeight>296.926mm</PageHeight>
  <PageWidth>209.804mm</PageWidth>
  <Width>7.5in</Width>
  <TopMargin>5mm</TopMargin>
  <LeftMargin>5mm</LeftMargin>
  <RightMargin>5mm</RightMargin>
  <BottomMargin>5mm</BottomMargin>
  <PageHeader>
    <Height>0.0pt</Height>
    <PrintOnFirstPage>true</PrintOnFirstPage>
    <PrintOnLastPage>true</PrintOnLastPage>
  </PageHeader>
  <Body>
    <Height>327.5pt</Height>
    <ReportItems>
      <Textbox Name="Textbox1">
        <Height>24.05pt</Height>
        <Width>568.40pt</Width>
        <Value>='Отчет по продажам ' + Iif(Parameters!start_date = Parameters!end_date, 'за ' + Format(CDate(Parameters!start_date), "dd/MM/yyyy"), 'с ' + Format(CDate(Parameters!start_date), "dd/MM/yyyy") + ' по ' + Format(CDate(Parameters!end_date), "dd/MM/yyyy"))</Value>
        <ZIndex>0</ZIndex>
        <Left>0.00pt</Left>
        <Top>21.90pt</Top>
        <Style>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
          <FontSize>16pt</FontSize>
          <TextAlign>Center</TextAlign>
        </Style>
      </Textbox>
      <Table Name="TableSales">
        <DataSetName>Sales</DataSetName>
        <NoRows>Query returned no rows!</NoRows>
        <Style>
          <BorderStyle>
            <Default>Solid</Default>
          </BorderStyle>
          <BorderColor />
          <BorderWidth />
        </Style>
        <TableColumns>
          <TableColumn>
            <Width>339.7pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>98.7pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>109.7pt</Width>
          </TableColumn>
        </TableColumns>
        <Header>
          <TableRows>
            <TableRow>
              <Height>11.3pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="TextboxItemHeader">
                      <Value>={?grouping_title}</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox3">
                      <Value>Количество</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox4">
                      <Value>Сумма</Value>
                      <Style>
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
            <TableRow>
              <Height>11.3pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox2">
                      <Value></Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth>
                          <Default>1pt</Default>
                          <Left>1pt</Left>
                          <Right>1pt</Right>
                          <Top>1pt</Top>
                          <Bottom>1pt</Bottom>
                        </BorderWidth>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox5">
                      <Value></Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth>
                          <Default>1pt</Default>
                          <Left>1pt</Left>
                          <Right>1pt</Right>
                          <Top>1pt</Top>
                          <Bottom>1pt</Bottom>
                        </BorderWidth>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox18">
                      <Value></Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <TextAlign>Center</TextAlign>
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <FontWeight>Bold</FontWeight>
                        <BorderColor />
                        <BorderWidth>
                          <Default>1pt</Default>
                          <Left>1pt</Left>
                          <Right>1pt</Right>
                          <Top>1pt</Top>
                          <Bottom>1pt</Bottom>
                        </BorderWidth>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
          <RepeatOnNewPage>true</RepeatOnNewPage>
        </Header>
        <Details>
          <TableRows>
            <TableRow>
              <Height>12 pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="TextboxItemData">
                      <Value>={order_item_id}</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox6">
                      <Value>=Fields!total_count.Value</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <Format>='N' + {digits}</Format>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox7">
                      <Value>=Fields!total_sum.Value</Value>
                      <CanGrow>true</CanGrow>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
        </Details>
        <Left>10.5pt</Left>
        <Top>47.4pt</Top>
        <Footer>
          <TableRows>
            <TableRow>
              <Height>.2in</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox8">
                      <Style>
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <TextAlign>Right</TextAlign>
                        <FontWeight>Bold</FontWeight>
                      </Style>
                      <Value>Итого:</Value>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox9">
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <FontWeight>Bold</FontWeight>
                        <Format>#,##0.00</Format>
                      </Style>
                      <Value>=Sum(Fields!total_count.Value)</Value>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox10">
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <FontWeight>Bold</FontWeight>
                        <Format>#,##0.00</Format>
                      </Style>
                      <Value>=Sum(Fields!total_sum.Value)</Value>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
        </Footer>
      </Table>
      <fyi:Grid xmlns:fyi="http://www.fyireporting.com/schemas" Name="Grid1">
        <Style>
          <BorderStyle>
            <Default>Solid</Default>
          </BorderStyle>
          <BorderColor />
          <BorderWidth />
        </Style>
        <TableColumns>
          <TableColumn>
            <Width>416.0pt</Width>
          </TableColumn>
          <TableColumn>
            <Width>133.8pt</Width>
          </TableColumn>
        </TableColumns>
        <Details>
          <TableRows>
            <TableRow>
              <Height>14.1pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox14">
                      <Value>={?filters}</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <VerticalAlign>Middle</VerticalAlign>
                        <TextAlign>Right</TextAlign>
                      </Style>
                      <CanGrow>true</CanGrow>
                    </Textbox>
                  </ReportItems>
                  <ColSpan>2</ColSpan>
                </TableCell>
              </TableCells>
            </TableRow>
            <TableRow>
              <Height>14.1pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox16">
                      <Value>="Количество заказов: " + Countdistinct({order_id}, "Sales")</Value>
                      <Style xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
                        <BorderStyle>
                          <Default>None</Default>
                          <Left>None</Left>
                          <Right>None</Right>
                          <Top>None</Top>
                          <Bottom>None</Bottom>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <VerticalAlign>Middle</VerticalAlign>
                        <TextAlign>Right</TextAlign>
                      </Style>
                    </Textbox>
                  </ReportItems>
                  <ColSpan>2</ColSpan>
                </TableCell>
              </TableCells>
            </TableRow>
            <TableRow>
              <Height>14.1pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox22">
                      <Value>Фактически забранная тара</Value>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <VerticalAlign>Middle</VerticalAlign>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox25">
                      <Value>=First( {fact} , "bottles" )</Value>
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <VerticalAlign>Middle</VerticalAlign>
                      </Style>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
        </Details>
        <Left>7.9pt</Left>
        <Top>175.3pt</Top>
        <Footer>
          <TableRows>
            <TableRow>
              <Height>13.7pt</Height>
              <TableCells>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox26">
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                        <VerticalAlign>Middle</VerticalAlign>
                      </Style>
                      <Value>Планируемая тара</Value>
                    </Textbox>
                  </ReportItems>
                </TableCell>
                <TableCell>
                  <ReportItems>
                    <Textbox Name="Textbox28">
                      <Style>
                        <BorderStyle>
                          <Default>Solid</Default>
                        </BorderStyle>
                        <BorderColor />
                        <BorderWidth />
                      </Style>
                      <Value>=First( {plan} , "bottles" )</Value>
                    </Textbox>
                  </ReportItems>
                </TableCell>
              </TableCells>
            </TableRow>
          </TableRows>
        </Footer>
      </fyi:Grid>
      <Textbox Name="Textbox17">
        <Height>12pt</Height>
        <Width>265pt</Width>
        <Value>="Сформировано: " + Format( {?creation_date}, "dd-MM-yyyy HH:mm")</Value>
        <ZIndex>0</ZIndex>
        <Left>300pt</Left>
        <Top>0.00pt</Top>
        <Style>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
          <TextAlign>Right</TextAlign>
        </Style>
      </Textbox>
    </ReportItems>
    <Columns>1</Columns>
  </Body>
  <PageFooter>
    <Height>13.2pt</Height>
    <PrintOnFirstPage>true</PrintOnFirstPage>
    <PrintOnLastPage>true</PrintOnLastPage>
    <ReportItems>
      <Textbox Name="Textbox12" xmlns="http://schemas.microsoft.com/sqlserver/reporting/2005/01/reportdefinition">
        <Height>12.05pt</Height>
        <Width>565.41pt</Width>
        <Value>='Стр. '+{@PageNumber}+' из '+{@TotalPages}</Value>
        <ZIndex>0</ZIndex>
        <Left>0.00pt</Left>
        <Top>0.00pt</Top>
        <Style>
          <BorderStyle />
          <BorderColor />
          <BorderWidth />
          <TextAlign>Center</TextAlign>
          <VerticalAlign>Middle</VerticalAlign>
        </Style>
        <CanGrow>true</CanGrow>
        <CanShrink>true</CanShrink>
      </Textbox>
    </ReportItems>
  </PageFooter>
  <DataSets>
    <DataSet Name="Sales">
      <Query >
        <DataSourceName>DS1</DataSourceName>
        <Timeout>600</Timeout>
        <CommandText>SELECT
    T.counterparty,
    T.counterparty_type,
    T.organization,
    T.delivery_point,
    T.order_id,
    T.payment_type,
    T.delivery_date,
    T.route_list,
    T.order_items_id,
    COUNT(DISTINCT T.order_id) as orders_count,
    T.nomenclature_name,
    T.nomenclature_category,
    SUM(T.total_count) AS total_count,
    SUM(T.total_sum) AS total_sum,
    T.is_disposable_tare,
    T.nomenclature_id as nomenclature_id,
    T.author_subdivision,
    T.author_subdivision_id,
    T.digits,
    T.nomen_group_level_1_name,
    T.nomen_group_level_2_name,
    T.nomen_group_level_3_name,
    T.nomen_group_level_1_id,
    T.nomen_group_level_2_id,
    T.nomen_group_level_3_id,
    sales_manager_name,
    order_author_name,
    counterparty_classification,
    promotional_set   
FROM
    (SELECT
         counterparty.name as counterparty,
         CASE WHEN counterparty.counterparty_type = 'Buyer' THEN "Покупатель"
              WHEN counterparty.counterparty_type = 'Supplier' THEN "Поставщик"
              WHEN counterparty.counterparty_type = 'Dealer' THEN "Дилер"
              WHEN counterparty.counterparty_type = 'AdvertisingDepartmentClient' AND counterparty.counterparty_subtype_id is null
              	THEN "Клиент РО"
              WHEN counterparty.counterparty_type = 'AdvertisingDepartmentClient' AND counterparty.counterparty_subtype_id is NOT null
              	THEN CONCAT("Клиент РО | ", cst.name)
         	  ELSE ""
         	  END as counterparty_type,
         cst.name AS counterparty_subtype,
         cst.id AS counterparty_subtype_id,
         org.name AS organization,
         counterparty.sales_manager_id as sales_manager_id,
         delivery_points.compiled_address as delivery_point,
         orders.id as order_id,
        CASE 
            WHEN orders.payment_type = 'Cash' THEN "Наличная"
            WHEN orders.payment_type = 'Terminal' THEN "Терминал"
            WHEN orders.payment_type = 'DriverApplicationQR' THEN "МП водителя (QR-код)"
            WHEN orders.payment_type = 'SmsQR' THEN "SMS (QR-код)"
            WHEN orders.payment_type = 'PaidOnline' THEN "Оплачено онлайн"
            WHEN orders.payment_type = 'Barter' THEN "Бартер"
            WHEN orders.payment_type = 'ContractDocumentation' THEN "Контрактная документация"
            WHEN orders.payment_type = 'Cashless' THEN "Безналичная"
            ELSE null
            END as payment_type_title,
        CASE 
            WHEN orders.terminal_subtype = 'ByCard' THEN "Картой"
            WHEN orders.terminal_subtype = 'ByQR' THEN "QR-код"
            ELSE null
            END as terminal_subtype_title,
        if(
            orders.payment_type = 'Terminal', 
            CONCAT((select payment_type_title), if((select terminal_subtype_title) is not null, CONCAT(' | ', (select terminal_subtype_title)), '')), 
            CONCAT((select payment_type_title), if(orders.payment_from_id is not null, CONCAT(' | ', pf.name), '')) 
        ) as payment_type,
         orders.delivery_date as delivery_date,
         rla.route_list_id AS route_list,
         order_items.id as order_items_id,
         nomenclature.official_name AS nomenclature_name,
         IFNULL(order_items.actual_count, order_items.count) AS total_count,
         truncate(IFNULL(order_items.actual_count, order_items.count) * order_items.price - order_items.discount_money, 2) AS total_sum,
         CASE WHEN nomenclature.category = 'rent' THEN "Аренда кулеров"
         	  WHEN nomenclature.category = 'water' THEN IF(nomenclature.is_disposable_tare, "Вода в одноразовой таре", "Вода в многооборотной таре")
         	  WHEN nomenclature.category = 'deposit' THEN "Залог"
         	  WHEN nomenclature.category = 'spare_parts' THEN "Запчасти сервисного центра"
         	  WHEN nomenclature.category = 'equipment' THEN "Оборудование"
         	  WHEN nomenclature.category = 'additional' THEN "Товары"
         	  WHEN nomenclature.category = 'service' THEN "Услуга"
         	  WHEN nomenclature.category = 'bottle' THEN "Тара"
         	  WHEN nomenclature.category = 'material' THEN "Сырьё"
         	  WHEN nomenclature.category = 'master' THEN "Сервисное обслуживание"
         	  ELSE nomenclature.category
         	  END AS nomenclature_category,
         nomenclature.is_disposable_tare,
         nomenclature.id as nomenclature_id,
         measurement_units.digits as digits,
         s.name as author_subdivision,
         s.id as author_subdivision_id,
         gg.id,
         IFNULL(group_levels.level_1_id, 0) as nomen_group_level_1_id,
         IFNULL(group_levels.level_1_name, 'Без группы') as nomen_group_level_1_name,
         IFNULL(group_levels.level_2_id, 0) as nomen_group_level_2_id,
         IFNULL(group_levels.level_2_name, 'Без группы') as nomen_group_level_2_name,
         IFNULL(group_levels.level_3_id, 0) as nomen_group_level_3_id,
         IFNULL(group_levels.level_3_name, 'Без группы') as nomen_group_level_3_name,
         IFNULL(CONCAT(cc.classification_by_bottles_count, cc.classification_by_orders_count), 'Новый') as counterparty_classification,
         IFNULL(ps.name, ' Без промонабора')  as promotional_set,
         IFNULL(CONCAT(e_manager.last_name,  ' ', e_manager.name, ' ', e_manager.patronymic), ' Без менеджера КА')  as sales_manager_name,
         IFNULL(CONCAT(e.last_name,  ' ', e.name, ' ', e.patronymic), ' Без автора заказа')  as order_author_name         
     FROM
        (
            # Выбор заказов по дате доставки
			select orders.* from orders where
				(orders.delivery_date &gt;= @start_date AND orders.delivery_date &lt;= @end_date AND @order_date_type = 'DeliveryDate')
            # Выбор заказов по дате создания заказа
			union all
			select orders.* from orders where 
                (orders.create_date &gt;= @start_date AND orders.create_date &lt;= @end_date AND @order_date_type = 'CreationDate')
            # Выбор заказов по дате оплаты безнала
			union all
			select orders.* from orders
			left join payment_items pi on pi.order_id = orders.id and pi.payment_item_status = 'Accepted'
			left join payments_from_bank_client pfbc on pfbc.id = pi.payment_id
			where 
                @order_date_type = 'PaymentDate' 
                AND orders.payment_type = 'Cashless'
                and orders.order_payment_status = 'Paid'
                AND pfbc.payment_date &gt;= @start_date 
                AND pfbc.payment_date &lt;= @end_date
            # Выбор заказов по дате оплаты СБП
			union all
			select orders.* from orders
			left join fast_payments fp on fp.order_id = orders.id and fp.payment_status = 'Performed' and fp.paid_date &gt;= @start_date AND fp.paid_date &lt;= @end_date
			where 
                @order_date_type = 'PaymentDate' AND
                (
                    orders.payment_type in ('DriverApplicationQR','SmsQR')
                    # Сайт по QR, Авангард по карте, МП по QR
                    or (orders.payment_type = 'PaidOnline' and orders.payment_from_id in (11, 12, 13))
                )				
                AND fp.paid_date &gt;= @start_date 
                AND fp.paid_date &lt;= @end_date
            # Выбор заказов по дате оплаты наличными и терминалом
			union all
			select orders.* from orders
			where 
					@order_date_type = 'PaymentDate' 
                    AND orders.payment_type in ('Cash','Terminal') 
                    AND orders.delivery_date &gt;= @start_date 
                    AND orders.delivery_date &lt;= @end_date
            # Выбор заказов по дате оплаты прочих типов онлайн оплаты
			union all
			select orders.* from orders
			where 
                @order_date_type = 'PaymentDate' AND
                (
                    orders.payment_type in ('Barter','ContractDocumentation','BeveragesWorld')
                    # Сайт, Приложение, ВК, Маркетплейс, Кулер Сейл, Сайт Я.Сплит, МП Я.Сплит
                    or (orders.payment_type = 'PaidOnline' and orders.payment_from_id in (1, 2, 3, 9, 14, 15, 16))
                )				
                AND orders.create_date &gt;= @start_date 
                AND orders.create_date &lt;= @end_date
		) as orders
             LEFT JOIN
         order_items ON order_id = orders.id
             LEFT JOIN
         route_list_addresses rla ON orders.id = rla.order_id AND rla.status not in ('Transfered', 'Canceled', 'Overdue')
             LEFT JOIN
         nomenclature ON order_items.nomenclature_id = nomenclature.id
             LEFT JOIN 
         measurement_units ON nomenclature.unit_id = measurement_units.id
             LEFT JOIN
         nomenclature_groups ON nomenclature.group_id = nomenclature_groups.id
             LEFT JOIN
         counterparty ON orders.client_id = counterparty.id
             LEFT JOIN
         counterparty_subtypes cst ON counterparty.counterparty_subtype_id = cst.id
             LEFT JOIN
         delivery_points ON orders.delivery_point_id = delivery_points.id
             LEFT JOIN
         counterparty_contract ON orders.counterparty_contract_id = counterparty_contract.id
             LEFT JOIN
         organizations org ON counterparty_contract.organization_id = org.id
             LEFT JOIN
         employees e ON orders.author_employee_id = e.id
             LEFT JOIN
         employees e_manager ON counterparty.sales_manager_id = e_manager.id
         	 LEFT JOIN
         subdivisions s ON e.subdivision_id = s.id       	 
             LEFT JOIN
         districts distr ON delivery_points.district_id = distr.id
             LEFT JOIN
         geo_groups gg ON gg.id = distr.geo_group_id
         	LEFT JOIN
		    (
			    SELECT 
					groups_with_levels.depth AS depth,
					groups_with_levels.id AS group_id,
					groups_with_levels.name AS group_name,
					groups_with_levels.level_1_id AS level_1_id,
					name_source_1.name AS level_1_name,
					groups_with_levels.level_2_id AS level_2_id,
					name_source_2.name AS level_2_name,
					groups_with_levels.level_3_id AS level_3_id,
					name_source_3.name AS level_3_name
				FROM
					(
						WITH RECURSIVE groups_source (depth, id, parent_id, name, level_1_id, level_2_id, level_3_id) AS (
							SELECT 
								1 AS depth,
								ng.id AS id,
								0 AS parent_id,
								ng.name,
								ng.id AS level_1_id, 
								0 AS level_2_id,
								0 AS level_3_id
						  	FROM nomenclature_groups ng
						  	WHERE ng.parent_id IS NULL
						  UNION
						  	SELECT 
								groups_source.depth + 1 AS depth,
								ng.id AS id,
								groups_source.id AS parent_id,
								ng.name,
								groups_source.level_1_id AS level_1_id,
								IF(groups_source.depth = 1, ng.id, groups_source.level_2_id) AS level_2_id, 
								IF(groups_source.depth = 2, ng.id, groups_source.level_3_id) AS level_3_id
						  	FROM nomenclature_groups ng, groups_source
						  	WHERE ng.parent_id = groups_source.id
						)
						SELECT * FROM groups_source
					) AS groups_with_levels
					LEFT JOIN nomenclature_groups name_source_1 ON name_source_1.id = groups_with_levels.level_1_id
					LEFT JOIN nomenclature_groups name_source_2 ON name_source_2.id = groups_with_levels.level_2_id
					LEFT JOIN nomenclature_groups name_source_3 ON name_source_3.id = groups_with_levels.level_3_id
		    ) group_levels ON group_levels.group_id = nomenclature.group_id
		    	LEFT JOIN 
		    counterparty_classification cc ON cc.counterparty_id = counterparty.id 
		    	AND cc.calculation_settings_id = 
					(SELECT cc2.calculation_settings_id as calc_settings_id 
					FROM counterparty_classification cc2
					ORDER BY cc2.id DESC 
					LIMIT 1)
		    	LEFT JOIN
		    promotional_sets ps ON ps.id = order_items.promotional_set_id
         	 LEFT JOIN
     	 route_lists rl ON rla.route_list_id = rl.id
          	 LEFT JOIN
	 	cars c ON rl.car_id = c.id
          	 LEFT JOIN
     	 car_models cm ON c.model_id= cm.id
     	 	 left join 
     	 payments_from pf on pf.id = orders.payment_from_id
     WHERE
       !orders.is_contract_closer
       AND (
             (0 IN (@Nomenclature_include) OR (nomenclature.id IN (@Nomenclature_include)))
				AND NOT (nomenclature.id IN (@Nomenclature_exclude))
         )
       AND (
             ('0' IN (@NomenclatureCategory_include) OR (nomenclature.category IN (@NomenclatureCategory_include)))
				AND (NOT (nomenclature.category IN (@NomenclatureCategory_exclude)) OR nomenclature.category IS NULL)
         )
       AND (
             (0 IN (@Counterparty_include) OR (orders.client_id IN (@Counterparty_include)))
				AND (NOT (orders.client_id IN (@Counterparty_exclude)) OR orders.client_id IS NULL)
         )
        AND
        (
            (
                ((('0' IN (@CounterpartyType_include))
                    AND (0 IN (@CounterpartySubtype_include)))
                OR (counterparty.counterparty_type IN (@CounterpartyType_include)))
                AND NOT (counterparty.counterparty_type IN (@CounterpartyType_exclude))
                AND (NOT (counterparty.counterparty_subtype_id IN (@CounterpartySubtype_exclude)) OR counterparty.counterparty_subtype_id IS NULL)
            )
            OR
            (
                ('0' IN (@CounterpartyType_include) OR NOT ('0' IN (@CounterpartySubtype_include)))
                AND counterparty.counterparty_type = 'AdvertisingDepartmentClient'
                AND NOT ('AdvertisingDepartmentClient' IN (@CounterpartyType_exclude))
                AND (0 IN (@CounterpartySubtype_include) OR counterparty.counterparty_subtype_id IN (@CounterpartySubtype_include))
                AND (NOT (counterparty.counterparty_subtype_id IN (@CounterpartySubtype_exclude)) OR counterparty.counterparty_subtype_id IS NULL)
            )
        )
       AND (
             (0 IN (@Organization_include) OR (counterparty_contract.organization_id IN (@Organization_include)))
                AND (counterparty_contract.organization_id IS NULL OR NOT (counterparty_contract.organization_id IN (@Organization_exclude))))
       AND (
             (0 IN (@DiscountReason_include) OR (order_items.discount_reason_id IN (@DiscountReason_include)))
				AND (order_items.discount_reason_id IS NULL OR NOT (order_items.discount_reason_id IN (@DiscountReason_exclude)))
         )
       AND (
             (0 IN (@Subdivision_include) OR (e.subdivision_id IN (@Subdivision_include)))
				AND NOT (e.subdivision_id IN (@Subdivision_exclude))
         )
       AND (
             (0 IN (@OrderAuthor_include) OR (orders.author_employee_id IN (@OrderAuthor_include)))
				AND NOT (orders.author_employee_id IN (@OrderAuthor_exclude))
         )
       AND (
             (0 IN (@SalesManager_include) OR (counterparty.sales_manager_id IN (@SalesManager_include)))
                AND (counterparty.sales_manager_id IS NULL OR NOT (counterparty.sales_manager_id IN (@SalesManager_exclude)))
         )
       AND (
             (0 IN (@GeoGroup_include) OR gg.id IN (@GeoGroup_include))
				AND (orders.delivery_point_id IS NULL OR NOT gg.id IN (@GeoGroup_exclude) OR gg.id IS NULL)
         )
        AND
        (
            (
                ((('0' IN (@PaymentType_include))
                        AND ('0' IN (@PaymentByTerminalSource_include))
                        AND ('0' IN (@PaymentFrom_include)))
                    OR (orders.payment_type IN (@PaymentType_include)))
                AND NOT (orders.payment_type IN (@PaymentType_exclude))
                AND (NOT (orders.terminal_subtype IN (@PaymentByTerminalSource_exclude)) OR orders.terminal_subtype IS NULL)
                AND (NOT (orders.payment_from_id IN (@PaymentFrom_exclude)) OR orders.payment_from_id IS NULL)
            )
            OR
            (
                ((('0' IN (@PaymentType_include))
                    AND ('0' IN (@PaymentFrom_include)))
                    OR NOT ('0' IN (@PaymentByTerminalSource_include)))
                AND orders.payment_type = 'Terminal'
                AND NOT ('Terminal' IN (@PaymentType_exclude))
                AND (('0' IN (@PaymentByTerminalSource_include))
                        OR (orders.terminal_subtype IN (@PaymentByTerminalSource_include)))
                AND (NOT (orders.terminal_subtype IN (@PaymentByTerminalSource_exclude)) OR orders.terminal_subtype IS NULL)
            )
            OR
            (
                ((('0' IN (@PaymentType_include))
                    AND ('0' IN (@PaymentByTerminalSource_include)))
                    OR NOT ('0' IN (@PaymentFrom_include)))
                AND orders.payment_type = 'PaidOnline'
                AND NOT ('PaidOnline' IN (@PaymentType_exclude))
                AND ((0 IN (@PaymentFrom_include))
                        OR (orders.payment_from_id IN (@PaymentFrom_include)))
                AND (NOT (orders.payment_from_id IN (@PaymentFrom_exclude)) OR orders.payment_from_id IS NULL)
            )
        )
       AND (
             (0 IN (@PromotionalSet_include) OR (IFNULL(order_items.promotional_set_id, 0) IN (@PromotionalSet_include)))
				AND (order_items.promotional_set_id IS NULL OR NOT order_items.promotional_set_id IN (@PromotionalSet_exclude))
         )
       AND (
             (0 IN (@ProductGroup_include) OR (IFNULL(nomenclature_groups.id, 0) IN (@ProductGroup_include)))
				AND (NOT (nomenclature_groups.id IN (@ProductGroup_exclude)) OR nomenclature_groups.id IS NULL)
         )
       AND 
	       (
             ('0' IN (@OrderStatus_include) OR orders.order_status IN (@OrderStatus_include))
				AND ('0' IN (@OrderStatus_exclude) OR orders.order_status NOT IN (@OrderStatus_exclude))
         )
       AND (
       	     (
       	     '0' IN (@CounterpartyCompositeClassification_include)
       	     OR ('AX' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'X')
       	     OR ('AY' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'Y')
       	     OR ('AZ' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'Z')
       	     OR ('BX' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'X')
       	     OR ('BY' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'Y')
       	     OR ('BZ' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'Z')
       	     OR ('CX' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'X')
       	     OR ('CY' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'Y')
       	     OR ('CZ' IN (@CounterpartyCompositeClassification_include) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'Z')
       	     OR ('New' IN (@CounterpartyCompositeClassification_include) AND (ISNULL(cc.classification_by_bottles_count) OR ISNULL(cc.classification_by_orders_count)))
       	     )
       	     AND NOT (
       	     ((
       	     ('AX' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'X')
	       	     OR ('AY' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'Y')
	       	     OR ('AZ' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'A' AND cc.classification_by_orders_count = 'Z')
	       	     OR ('BX' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'X')
	       	     OR ('BY' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'Y')
	       	     OR ('BZ' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'B' AND cc.classification_by_orders_count = 'Z')
	       	     OR ('CX' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'X')
	       	     OR ('CY' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'Y')
	       	     OR ('CZ' IN (@CounterpartyCompositeClassification_exclude) AND cc.classification_by_bottles_count = 'C' AND cc.classification_by_orders_count = 'Z'))
       	     	AND NOT (ISNULL(cc.classification_by_bottles_count) OR ISNULL(cc.classification_by_orders_count)))
       	     OR ('New' IN (@CounterpartyCompositeClassification_exclude) AND (ISNULL(cc.classification_by_bottles_count) OR ISNULL(cc.classification_by_orders_count)))
       	     )
       	   )
       AND (@is_self_delivery IS NULL OR orders.self_delivery = @is_self_delivery)
       AND (
    		 @only_with_cash_receipts IS NULL
    		 OR (
   	    		 	@only_with_cash_receipts = TRUE
   	    			AND EXISTS
		       	    (
		       	     	select efd.id from edo_fiscal_documents efd 
						join edo_tasks et on efd.receipt_edo_task_id = et.id
						join edo_customer_requests ecr on ecr.order_task_id = et.id
						where efd.status in ('WaitingForCallBack','Printed','Completed')
						and ecr.order_id = orders.id
					)
				)
			OR (
   	    		 	@only_with_cash_receipts = FALSE
   	    			AND NOT EXISTS
		       	    (
		       	     	select efd.id from edo_fiscal_documents efd 
						join edo_tasks et on efd.receipt_edo_task_id = et.id
						join edo_customer_requests ecr on ecr.order_task_id = et.id
						where efd.status in ('WaitingForCallBack','Printed','Completed')
						and ecr.order_id = orders.id
					)
				)
     	)
     	AND (
     		@only_orders_from_route_lists IS NULL
     		OR (
     			@only_orders_from_route_lists = TRUE
     			AND	rla.id is not null AND cm.car_type_of_use != 'Truck'
 		)
     		OR (
     			@only_orders_from_route_lists = FALSE
     			AND	rla.id is null
     		)
 	)
     GROUP BY order_items.id
    ) as T
GROUP BY T.order_items_id
;</CommandText>
        <QueryParameters>
          <QueryParameter Name="start_date">
            <Value>=Parameters!start_date</Value>
          </QueryParameter>
          <QueryParameter Name="end_date">
            <Value>=Parameters!end_date</Value>
          </QueryParameter>
          <QueryParameter Name="order_date_type">
            <Value>={?order_date_type}</Value>
          </QueryParameter>
          <QueryParameter Name="Nomenclature_include">
            <Value>=Parameters!Nomenclature_include</Value>
          </QueryParameter>
          <QueryParameter Name="Nomenclature_exclude">
            <Value>=Parameters!Nomenclature_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="NomenclatureCategory_include">
            <Value>=Parameters!NomenclatureCategory_include</Value>
          </QueryParameter>
          <QueryParameter Name="NomenclatureCategory_exclude">
            <Value>=Parameters!NomenclatureCategory_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="DiscountReason_include">
            <Value>=Parameters!DiscountReason_include</Value>
          </QueryParameter>
          <QueryParameter Name="DiscountReason_exclude">
            <Value>=Parameters!DiscountReason_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="Organization_include">
            <Value>=Parameters!Organization_include</Value>
          </QueryParameter>
          <QueryParameter Name="Organization_exclude">
            <Value>=Parameters!Organization_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="Counterparty_include">
            <Value>=Parameters!Counterparty_include</Value>
          </QueryParameter>
          <QueryParameter Name="Counterparty_exclude">
            <Value>=Parameters!Counterparty_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="OrderAuthor_include">
            <Value>=Parameters!OrderAuthor_include</Value>
          </QueryParameter>
          <QueryParameter Name="OrderAuthor_exclude">
            <Value>=Parameters!OrderAuthor_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="SalesManager_include">
            <Value>=Parameters!SalesManager_include</Value>
          </QueryParameter>
          <QueryParameter Name="SalesManager_exclude">
            <Value>=Parameters!SalesManager_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="Subdivision_include">
            <Value>=Parameters!Subdivision_include</Value>
          </QueryParameter>
          <QueryParameter Name="Subdivision_exclude">
            <Value>=Parameters!Subdivision_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="GeoGroup_include">
            <Value>=Parameters!GeoGroup_include</Value>
          </QueryParameter>
          <QueryParameter Name="GeoGroup_exclude">
            <Value>=Parameters!GeoGroup_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentType_include">
            <Value>={?PaymentType_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentType_exclude">
            <Value>={?PaymentType_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PromotionalSet_include">
            <Value>={?PromotionalSet_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PromotionalSet_exclude">
            <Value>={?PromotionalSet_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="ProductGroup_include">
            <Value>={?ProductGroup_include}</Value>
          </QueryParameter>
          <QueryParameter Name="ProductGroup_exclude">
            <Value>={?ProductGroup_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentByTerminalSource_include">
            <Value>={?PaymentByTerminalSource_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentByTerminalSource_exclude">
            <Value>={?PaymentByTerminalSource_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentFrom_include">
            <Value>={?PaymentFrom_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentFrom_exclude">
            <Value>={?PaymentFrom_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderStatus_include">
            <Value>={?OrderStatus_include}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderStatus_exclude">
            <Value>={?OrderStatus_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyType_include">
            <Value>={?CounterpartyType_include}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyType_exclude">
            <Value>={?CounterpartyType_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartySubtype_include">
            <Value>={?CounterpartySubtype_include}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartySubtype_exclude">
            <Value>={?CounterpartySubtype_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyCompositeClassification_include">
            <Value>={?CounterpartyCompositeClassification_include}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyCompositeClassification_exclude">
            <Value>={?CounterpartyCompositeClassification_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="is_self_delivery">
            <Value>={?is_self_delivery}</Value>
          </QueryParameter>
          <QueryParameter Name="only_with_cash_receipts">
            <Value>={?only_with_cash_receipts}</Value>
          </QueryParameter>
          <QueryParameter Name="only_orders_from_route_lists">
            <Value>={?only_orders_from_route_lists}</Value>
          </QueryParameter>
        </QueryParameters>
      </Query>
      <Fields >
        <Field Name="nomenclature_name">
          <DataField>nomenclature_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="total_count">
          <DataField>total_count</DataField>
          <TypeName>System.Decimal</TypeName>
        </Field>
        <Field Name="total_sum">
          <DataField>total_sum</DataField>
          <TypeName>System.Decimal</TypeName>
        </Field>
        <Field Name="nomenclature_category">
          <DataField>nomenclature_category</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="counterparty">
          <DataField>counterparty</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="delivery_point">
          <DataField>delivery_point</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="order_id">
          <DataField>order_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="is_disposable_tare">
          <DataField>is_disposable_tare</DataField>
          <TypeName>System.Boolean</TypeName>
        </Field>
        <Field Name="orders_count">
          <DataField>orders_count</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="digits">
          <DataField>digits</DataField>
          <TypeName>System.UInt32</TypeName>
        </Field>
        <Field Name="nomenclature_id">
          <DataField>nomenclature_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="delivery_date">
          <DataField>delivery_date</DataField>
          <TypeName>System.DateTime</TypeName>
        </Field>
        <Field Name="route_list">
          <DataField>route_list</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="author_subdivision">
          <DataField>author_subdivision</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="nomen_group_level_1_name">
          <DataField>nomen_group_level_1_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="nomen_group_level_2_name">
          <DataField>nomen_group_level_2_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="nomen_group_level_3_name">
          <DataField>nomen_group_level_3_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="counterparty_type">
          <DataField>counterparty_type</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="payment_type">
          <DataField>payment_type</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="organization">
          <DataField>organization</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="author_subdivision_id">
          <DataField>author_subdivision_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="nomen_group_level_1_id">
          <DataField>nomen_group_level_1_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="nomen_group_level_2_id">
          <DataField>nomen_group_level_2_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="nomen_group_level_3_id">
          <DataField>nomen_group_level_3_id</DataField>
          <TypeName>System.Int32</TypeName>
        </Field>
        <Field Name="counterparty_classification">
          <DataField>counterparty_classification</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="promotional_set">
          <DataField>promotional_set</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="sales_manager_name">
          <DataField>sales_manager_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
        <Field Name="order_author_name">
          <DataField>order_author_name</DataField>
          <TypeName>System.String</TypeName>
        </Field>
      </Fields>
    </DataSet>
    <DataSet Name="bottles">
      <Query>
        <DataSourceName>DS1</DataSourceName>
        <Timeout>600</Timeout>
        <CommandText>SELECT
    SUM(t.plan) AS plan,
    ROUND(SUM(t.fact), 0) AS fact
FROM
    (
        SELECT
            orders.bottles_return AS plan,
            IFNULL(route_list_addresses.bottles_returned,IFNULL(self_delivery.fact,0)) AS fact
        FROM
            orders
                LEFT JOIN route_list_addresses ON route_list_addresses.order_id = orders.id AND route_list_addresses.transfered_to_id IS NULL
                LEFT JOIN
            (
                SELECT
                    SUM(store_self_delivery_document_item.amount) AS fact,
                    store_self_delivery_document.order_id
                FROM
                    store_self_delivery_document
                        LEFT JOIN store_self_delivery_document_item ON store_self_delivery_document_item.store_self_delivery_document_id = store_self_delivery_document.id
                WHERE
                        store_self_delivery_document_item.nomenclature_id =
                        (
                            SELECT
                                base_parameters.str_value
                            FROM
                                base_parameters
                            WHERE
                                    base_parameters.name = 'default_bottle_nomenclature'
                            LIMIT 1
                        )
                GROUP BY store_self_delivery_document.order_id
            ) AS self_delivery ON self_delivery.order_id = orders.id
        WHERE
                orders.id IN (@OrderIds)
        GROUP BY orders.id
    ) AS t;</CommandText>
        <QueryParameters>
          <QueryParameter Name="start_date">
            <Value>={?start_date}</Value>
          </QueryParameter>
          <QueryParameter Name="end_date">
            <Value>={?end_date}</Value>
          </QueryParameter>
          <QueryParameter Name="DiscountReason_include">
            <Value>={?DiscountReason_include}</Value>
          </QueryParameter>
          <QueryParameter Name="DiscountReason_exclude">
            <Value>={?DiscountReason_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="Counterparty_include">
            <Value>={?Counterparty_include}</Value>
          </QueryParameter>
          <QueryParameter Name="Counterparty_exclude">
            <Value>={?Counterparty_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="Organization_include">
            <Value>={?Organization_include}</Value>
          </QueryParameter>
          <QueryParameter Name="Organization_exclude">
            <Value>={?Organization_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="Subdivision_include">
            <Value>={?Subdivision_include}</Value>
          </QueryParameter>
          <QueryParameter Name="Subdivision_exclude">
            <Value>={?Subdivision_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderAuthor_include">
            <Value>={?OrderAuthor_include}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderAuthor_exclude">
            <Value>={?OrderAuthor_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="GeoGroup_include">
            <Value>={?GeoGroup_include}</Value>
          </QueryParameter>
          <QueryParameter Name="GeoGroup_exclude">
            <Value>={?GeoGroup_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentType_include">
            <Value>={?PaymentType_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentType_exclude">
            <Value>={?PaymentType_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PromotionalSet_include">
            <Value>={?PromotionalSet_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PromotionalSet_exclude">
            <Value>={?PromotionalSet_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="ProductGroup_include">
            <Value>={?ProductGroup_include}</Value>
          </QueryParameter>
          <QueryParameter Name="ProductGroup_exclude">
            <Value>={?ProductGroup_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentByTerminalSource_include">
            <Value>={?PaymentByTerminalSource_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentByTerminalSource_exclude">
            <Value>={?PaymentByTerminalSource_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentFrom_include">
            <Value>={?PaymentFrom_include}</Value>
          </QueryParameter>
          <QueryParameter Name="PaymentFrom_exclude">
            <Value>={?PaymentFrom_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderStatus_include">
            <Value>={?OrderStatus_include}</Value>
          </QueryParameter>
          <QueryParameter Name="OrderStatus_exclude">
            <Value>={?OrderStatus_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyType_include">
            <Value>={?CounterpartyType_include}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartyType_exclude">
            <Value>={?CounterpartyType_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartySubtype_include">
            <Value>={?CounterpartySubtype_include}</Value>
          </QueryParameter>
          <QueryParameter Name="CounterpartySubtype_exclude">
            <Value>={?CounterpartySubtype_exclude}</Value>
          </QueryParameter>
          <QueryParameter Name="Nomenclature_include">
            <Value>=Parameters!Nomenclature_include</Value>
          </QueryParameter>
          <QueryParameter Name="Nomenclature_exclude">
            <Value>=Parameters!Nomenclature_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="NomenclatureCategory_include">
            <Value>=Parameters!NomenclatureCategory_include</Value>
          </QueryParameter>
          <QueryParameter Name="NomenclatureCategory_exclude">
            <Value>=Parameters!NomenclatureCategory_exclude</Value>
          </QueryParameter>
          <QueryParameter Name="OrderIds">
            <Value>=Parameters!order_ids</Value>
          </QueryParameter>
        </QueryParameters>
      </Query>
      <Fields>
        <Field Name="plan">
          <DataField>plan</DataField>
        </Field>
        <Field Name="fact">
          <DataField>fact</DataField>
        </Field>
      </Fields>
    </DataSet>
  </DataSets>
  <DataElementName>Report</DataElementName>
  <DataElementStyle>AttributeNormal</DataElementStyle>
  <DataSources>
    <DataSource Name="DS1">
      <ConnectionProperties>
        <DataProvider>MySqlConnector</DataProvider>
        <ConnectString></ConnectString>
        <IntegratedSecurity>false</IntegratedSecurity>
      </ConnectionProperties>
    </DataSource>
  </DataSources>
  <ReportParameters>
    <ReportParameter Name="start_date">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="end_date">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="order_date_type">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="creation_date">
      <DataType>DateTime</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Nomenclature_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Nomenclature_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="NomenclatureCategory_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="NomenclatureCategory_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Counterparty_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Counterparty_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Organization_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Organization_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="DiscountReason_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="DiscountReason_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="OrderAuthor_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="OrderAuthor_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="SalesManager_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="SalesManager_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Subdivision_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="Subdivision_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="GeoGroup_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="GeoGroup_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentType_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentType_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PromotionalSet_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PromotionalSet_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="ProductGroup_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="ProductGroup_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentByTerminalSource_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentByTerminalSource_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentFrom_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="PaymentFrom_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="OrderStatus_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="OrderStatus_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartyType_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartyType_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartySubtype_include">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartySubtype_exclude">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="group1">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="group2">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="group3">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="groups_count">
      <DataType>Integer</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="grouping_title">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="order_ids">
      <DataType>Integer</DataType>
      <DefaultValue>
        <DataSetReference>
          <DataSetName>Sales</DataSetName>
          <ValueField>order_id</ValueField>
        </DataSetReference>
      </DefaultValue>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartyCompositeClassification_include">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="CounterpartyCompositeClassification_exclude">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>true</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="is_self_delivery">
      <DataType>Boolean</DataType>
      <Nullable>true</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="only_with_cash_receipts">
      <DataType>Boolean</DataType>
      <Nullable>true</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="only_orders_from_route_lists">
      <DataType>Boolean</DataType>
      <Nullable>true</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt></Prompt>
    </ReportParameter>
    <ReportParameter Name="filters">
      <DataType>String</DataType>
      <Nullable>false</Nullable>
      <AllowBlank>false</AllowBlank>
      <MultiValue>false</MultiValue>
      <Prompt />
    </ReportParameter>
  </ReportParameters>
</Report>